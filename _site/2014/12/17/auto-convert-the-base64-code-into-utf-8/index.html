
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="author" content="Jingbei Li" />
    <title>Auto convert the base64 code in Abook</title>

    <link rel="stylesheet" href="/assets/themes/dinky/css/styles.css">
    <link rel="stylesheet" href="/assets/themes/dinky/css/pygment_trac.css">
    <script src="/assets/themes/dinky/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header"><a href="/">Jingbei Li's Blog</a></h1>
        <p class="header">Welcome!</p>
        <ul>
          
          
          


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/index.html">Homepage</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Categories</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/timeline.html">Timeline</a></li>
      	
      
    
  



	  <li><a href="/about.html" rel="me">About me</a></li>
        </ul>
	<!--<h4>Quick Links</h4>
        <ul>
	  <li><a href="/index.html#recent-posts" rel="me">Recent Posts</a></li>
	  <li><a href="/index.html#github-activity" rel="me">Github Activity</a></li>
	  <li><a href="/index.html#recent-comments" rel="me">Recent Comments</a></li>
        </ul>-->
        <ul>
	  <li><a href="/links.html">Other links</a></li>
        </ul>
        <ul>
	  <li><a href="/rss.xml">RSS</a>/<a href="/atom.xml">Atom</a></li>
        </ul>
        
        
        <div class="misc vcard">
	  <!--<h4>About</h4>-->
          <ul>
            
            <!--<li class="contact"><address><span class="author fn n">Jingbei Li</span> - <span class="fn email">jingbei.li@yahoo.com</span></address></li>-->
            
            
            <!--<li class="github"><a href="http://github.com/petronny/" rel="me">github.com/petronny</a></li>-->
            
            
            <!--<li class="twitter"><a href="http://twitter.com/jingbei_li/" rel="me">twitter.com/jingbei_li</a></li>-->
            
            
            
            
            
          </ul>
        </div><!-- misc -->
        
      </header>

      <section>
      
<section>
  <h1>Auto convert the base64 code in Abook</h1>

  <h4>17 December 2014</h4>


  <p><a href="http://abook.sourceforge.net/">Abook</a> is a text-based addressbook program designed to use with <a href="http://www.mutt.org/">mutt</a> mail client.</p>

<p>There is a chapter about using abook with mutt in the <a href="https://wiki.archlinux.org/index.php/Mutt#Abook">ArchWiki</a>.</p>

<p>If you want to use <strong>Abook</strong> instead of aliases, remove the aliases configuration in <code>.muttrc</code> and add this:</p>

<pre><code>set query_command= "abook --mutt-query '%s'"
macro index,pager  a "&lt;pipe-message&gt;abook --add-email-quiet&lt;return&gt;" "Add this sender to Abook"
bind editor        &lt;Tab&gt; complete-query
</code></pre>

<p>But sadly, the command <code>abook --add-email-quiet</code> always gets names like “=?utf-8?B?55m+5ZCI5LuZ5a2Q?=” which is base64 encoded.</p>

<p>To convert the base64 string and automatically fit the correct encoding, you can use a shell function:</p>

<div class="highlight"><pre><code class="language-sh" data-lang="sh">conv<span class="o">()</span> <span class="o">{</span>
	<span class="nb">eval</span> <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$1</span> <span class="p">|</span> awk -F <span class="s1">&#39;?&#39;</span> <span class="s1">&#39;{ print &quot;echo &quot; $4 &quot; | base64 -d | iconv -f &quot; $2 }&#39;</span><span class="sb">`</span>
<span class="o">}</span></code></pre></div>

<p>Then:</p>

<pre><code>$ conv name==?utf-8?B?55m+5ZCI5LuZ5a2Q?=
</code></pre>

<p>Or a python script like this:</p>

<div class="highlight"><pre><code class="language-cython" data-lang="cython"><span class="c">#!/usr/bin/env python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="k">import</span> <span class="nn">email</span>
<span class="k">import</span> <span class="nn">email.header</span>
<span class="k">import</span> <span class="nn">sys</span>
<span class="k">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">abookdecode</span><span class="p">(</span><span class="n">origin_name</span><span class="p">):</span>
    <span class="n">name</span><span class="o">=</span><span class="n">email</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">decode_header</span><span class="p">(</span><span class="n">origin_name</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">name</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span>
	<span class="k">else</span><span class="p">:</span>
	    <span class="k">return</span> <span class="n">name</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mf">0</span><span class="p">][</span><span class="mf">1</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s">&#39;__main__&#39;</span><span class="o">==</span><span class="n">__name__</span><span class="p">:</span>
	<span class="n">infile</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">content</span><span class="o">=</span><span class="n">infile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">outfile</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="s">&quot;wb&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
	<span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mf">0</span><span class="p">:</span><span class="mf">4</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;name&#39;</span><span class="p">:</span>
	    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mf">0</span><span class="p">:</span><span class="mf">5</span><span class="p">]</span><span class="o">+</span><span class="n">abookdecode</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mf">5</span><span class="p">:</span><span class="o">-</span><span class="mf">1</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
	    <span class="k">else</span><span class="p">:</span>
		<span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div>

<p>And then change your <code>.muttrc</code> to call the script:</p>

<pre><code>macro index,pager  a "&lt;pipe-message&gt;abook --add-email-quiet &amp;&amp; abook-decode ~/.abook/addressbook&lt;return&gt;" "Add this sender to Abook"
</code></pre>

<p>Now the addressbook will be written correctly.</p>



  
    <ul class="tag_box inline">
      
      


  
     
    	<li><a href="/tags.html#abook-ref">abook <span>1</span></a></li>
     
    	<li><a href="/tags.html#linux-ref">linux <span>7</span></a></li>
     
    	<li><a href="/tags.html#mutt-ref">mutt <span>2</span></a></li>
     
    	<li><a href="/tags.html#python-ref">python <span>1</span></a></li>
     
    	<li><a href="/tags.html#script-ref">script <span>5</span></a></li>
    
  



    </ul>
    

  


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jingbei'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




</section>


      </section>

      <footer>
	<script src="//static.getclicky.com/js" type="text/javascript"></script>
	<script type="text/javascript">try{ clicky.init(100811122); }catch(e){}</script>
	<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100811122ns.gif" /></p></noscript>
	<style type="text/css"> 
		#outerdiv 
		{ 
			width:150px; 
			height:145px; 
			overflow:hidden; 
			position:relative; 
		} 
		#inneriframe 
		{ 
			position:absolute; 
			top:-24px; 
			left:-5px; 
			width:150; 
			height:170; 
		} 
	</style> 
	<div id='outerdiv'> 
		<iframe id='inneriframe' frameborder=0 scrolling=no width=160 height=170 src='//widgets.clicky.com/tally/iframe?site_id=100811122&sitekey=f1e4ee97d7209bdfe74c0ce79738c86c&hide_title=1&hide_branding=1&'></iframe>
	</div>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  </body>
</html>

